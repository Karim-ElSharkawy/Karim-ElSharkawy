name: Daily Contributions

on:
  schedule:
    - cron: '0 0 * * 0-6'  # Run daily, every day of the week
  workflow_dispatch:

jobs:
  make-contribution:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Fetch contributions from the GitHub API
        run: |
          YEAR=$(date +'%Y')
          PREVIOUS_YEAR=$((YEAR - 1))
          
          # GitHub API to get contributions (private and public)
          CONTRIBUTIONS_API_URL="https://api.github.com/users/${{ github.actor }}/events"
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" $CONTRIBUTIONS_API_URL)
          
          # Count the number of contributions for the current year
          CURRENT_COUNT=$(echo "$RESPONSE" | jq '[.[] | select(.created_at | startswith("'$(date +'%Y')'-"))] | length')
          PREVIOUS_COUNT=$(echo "$RESPONSE" | jq '[.[] | select(.created_at | startswith("'$(date +'%Y' - 1)'-"))] | length')
          
          # Log the current contribution count
          echo "Contributions for $YEAR: $CURRENT_COUNT"
          echo "Contributions for $PREVIOUS_YEAR: $PREVIOUS_COUNT"

          # Check if README.md contains a contributions section
          CONTRIBUTIONS_SECTION="## Daily Contributions"
          
          # If the section exists, update; otherwise, create it
          if grep -q "$CONTRIBUTIONS_SECTION" README.md; then
            sed -i "s/Contributions for the year $YEAR: .*/Contributions for the year $YEAR: $CURRENT_COUNT/" README.md
            sed -i "s/Contributions for the previous year $PREVIOUS_YEAR: .*/Contributions for the previous year $PREVIOUS_YEAR: $PREVIOUS_COUNT/" README.md
          else
            echo "$CONTRIBUTIONS_SECTION" >> README.md
            echo "### Contributions for the year $YEAR: $CURRENT_COUNT" >> README.md
            echo "### Contributions for the previous year $PREVIOUS_YEAR: $PREVIOUS_COUNT" >> README.md
          fi

      - name: Commit changes
        uses: EndBug/add-and-commit@v7
        with:
          author_name: "GitHub Actions"
          author_email: "actions@github.com"
          message: "Daily contribution update"
          add: "README.md"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          branch: daily-contribution
          github_token: ${{ secrets.PAT_TOKEN }}

      - name: Open pull request
        uses: peter-evans/create-pull-request@v3
        with:
          title: "Daily Contribution Update"
          commit-message: "Daily contribution update"
          branch: daily-contribution
          base: main
          body: "This pull request was created automatically by a GitHub Actions workflow to update the contribution counts for the current and previous years."
          token: ${{ secrets.PAT_TOKEN }}

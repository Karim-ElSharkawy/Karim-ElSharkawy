name: Daily Contributions

on:
  schedule:
    - cron: '0 0 * * 0-6'  # Run daily, every day of the week
  workflow_dispatch:

jobs:
  make-contribution:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Fetch latest contribution date from the GitHub API
        run: |
          YEAR=$(date +'%Y')
          PREVIOUS_YEAR=$((YEAR - 1))

          # GitHub API to get contributions (private and public)
          CONTRIBUTIONS_API_URL="https://api.github.com/users/${{ github.actor }}/events"
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" $CONTRIBUTIONS_API_URL)
          
          # Get the latest contribution date
          LATEST_CONTRIBUTION_DATE=$(echo "$RESPONSE" | jq -r '.[0].created_at' | cut -d'T' -f1)

          # Log the latest contribution date
          echo "Latest contribution date: $LATEST_CONTRIBUTION_DATE"

          # Check if README.md contains a contributions section
          CONTRIBUTIONS_SECTION="## Contributions"
          
          # If the section exists, update; otherwise, create it
          if grep -q "$CONTRIBUTIONS_SECTION" README.md; then
            sed -i "s/Latest contribution date: .*/Latest contribution date: $LATEST_CONTRIBUTION_DATE/" README.md
          else
            echo "$CONTRIBUTIONS_SECTION" >> README.md
            echo "### Latest contribution date (automatic): $LATEST_CONTRIBUTION_DATE" >> README.md
          fi

      - name: Commit changes
        uses: EndBug/add-and-commit@v7
        with:
          author_name: "GitHub Actions"
          author_email: "actions@github.com"
          message: "Daily contribution update"
          add: "README.md"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          branch: daily-contribution
          github_token: ${{ secrets.PAT_TOKEN }}

      - name: Open pull request
        uses: peter-evans/create-pull-request@v3
        with:
          title: "Daily Contribution Update"
          commit-message: "Daily contribution update"
          branch: daily-contribution
          base: main
          body: "This pull request was created automatically by a GitHub Actions workflow to update the latest contribution date."
          token: ${{ secrets.PAT_TOKEN }}

      - name: Delete branch after merge
        if: github.event.pull_request.merged == true
        uses: SvanBoxel/delete-merged-branch@main
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
